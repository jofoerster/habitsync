<!DOCTYPE html>
<html layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Your Habits</title>
    <script defer th:src="@{/js/habits.js}"></script>
</head>
<body>
<div layout:fragment="page-title">Your Habits
    <a class="btn btn-primary" href="/habits?sync-now">
        <span id="updateButtonText">Update</span>
    </a>

</div>

<div layout:fragment="content">
    <div class="filter-bar">
        <div class="filter-option" data-filter="all">All Habits</div>
        <div class="filter-option active" data-filter="shared">Shared</div>
    </div>

    <!-- Empty state -->
    <div class="empty-state" th:if="${habits.empty}">
        <div class="empty-state-icon">
            <i class="bi bi-calendar-x"></i>
        </div>
        <h2>No habits yet</h2>
        <p>Create a new habit on the habit tracker page.</p>
        <div class="mt-4">
            <a href="/habit/tracker">
                <button class="btn btn-primary me-2">
                    <i class="bi bi-folder-symlink me-1"></i> Use internal habit tracker
                </button>
            </a>
        </div>
        <p>Create a new connection to your Habit Tracking App to sync your habits.</p>
        <div class="mt-4">
            <a href="/connection/list">
                <button class="btn btn-primary me-2">
                    <i class="bi bi-folder-symlink me-1"></i> Create Connection
                </button>
            </a>
        </div>
    </div>

    <!-- Habits List -->
    <div class="row g-3" th:if="${!habits.empty}">
        <!-- Hide normal habits on opening habit page-->
        <div class="col-md-6 col-lg-4" style="display: none" th:each="habit : ${habits}">
            <div class="card habit-card" th:attr="data-color=${habit.color}">
                <div class="card-body position-relative">
                    <a class="no-decorations" th:href="@{'/habit/' + ${habit.uuid}}">
                        <div class="streak-badge">
                            <i class="bi bi-fire"></i>
                            <span th:text="${recordSupplier.countRecordsByHabitSinceDays(habit, habit.getTargetDays())} + '/' + ${habit.getTargetDays()} + ' days'"></span>
                        </div>

                        <h5 class="card-title" th:text="${habit.name}"></h5>
                        <p class="card-text text-muted" th:if="${habit.desc}" th:text="${habit.desc}"></p>

                        <div class="habit-progress">
                            <div class="habit-progress-bar"
                                 th:style="'width: ' + ${habit.getCompletionPercentage(recordSupplier)} + '%'"></div>
                        </div>

                        <div class="habit-meta">
                            <div class="habit-meta-item">
                                <i class="bi bi-bullseye"></i>
                                <span th:text="${habit.getReachableDailyValue() + ' ' + habit.dailyGoalUnit}"></span>
                            </div>
                            <div class="habit-meta-item">
                                <i class="bi bi-calendar-check"></i>
                                <span th:if="${habit.freqType == 1}"
                                      th:text="${habit.parseFrequencyValue() + ' times per week'}"></span>
                                <span th:if="${habit.freqType == 2}"
                                      th:text="${habit.parseFrequencyValue() + ' times per month'}"></span>
                                <span th:if="${habit.freqType == 3 && habit.freqCustom == '[1,1]'}"
                                      th:text="${'daily'}"></span>
                                <span th:if="${habit.freqType == 3 && habit.freqCustom != '[1,1]'}"
                                      th:text="${habit.parseCustomFrequency()[0] + ' times per ' + habit.parseCustomFrequency()[1] + ' days'}"></span>
                            </div>
                        </div>
                    </a>
                    <div class="habit-actions">
                        <a class="btn btn-sm btn-primary" th:href="@{'/habit/' + ${habit.uuid}}">
                            <i class="bi bi-eye me-1"></i> View
                        </a>
                        <a class="btn btn-sm btn-success" th:href="@{'/habit/' + ${habit.uuid} + '/share'}">
                            <i class="bi bi-share me-1"></i> Share
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shared Habits Section -->
    <div class="mt-5" th:if="${!sharedHabits.empty}">
        <h3 class="mb-3">Shared Habit Groups</h3>

        <div class="row g-3">
            <div class="col-md-12 col-lg-6" th:each="sharedHabit : ${sharedHabits}">
                <div class="card habit-card" th:attr="data-color=${sharedHabit.getHabits().iterator().next().color}">

                    <div class="card-body position-relative">
                        <a class="no-decorations" th:href="@{'/shared/' + ${sharedHabit.shareCode}}">
                            <div class="streak-badge">
                                <i class="bi"></i>
                                <span th:text="${sharedHabit.habits.size() + ' participants'}"></span>
                            </div>

                            <h5 class="card-title" th:text="${sharedHabit.title}"></h5>
                            <div th:with="intHabit=${sharedHabit.getTemporaryMainNotificationRule(notificationRuleService, null).getInternalHabitForComputationOfGoal()}">
                                <div class="habit-meta-item">
                                    <i class="bi bi-bullseye"></i>
                                    <span th:text="${intHabit.getReachableDailyValue() + ' ' + (intHabit.dailyGoalUnit != null ? intHabit.dailyGoalUnit : '')}"></span>
                                </div>
                                <div class="habit-meta-item">
                                    <i class="bi bi-calendar-check"></i>
                                    <span th:if="${intHabit.freqType == 1}"
                                          th:text="${intHabit.parseFrequencyValue() + ' times per week'}"></span>
                                    <span th:if="${intHabit.freqType == 2}"
                                          th:text="${intHabit.parseFrequencyValue() + ' times per month'}"></span>
                                    <span th:if="${intHabit.freqType == 3 && intHabit.freqCustom == '[1,1]'}"
                                          th:text="${'daily'}"></span>
                                    <span th:if="${intHabit.freqType == 3 && intHabit.freqCustom != '[1,1]'}"
                                          th:text="${intHabit.parseCustomFrequency()[0] + ' times per ' + intHabit.parseCustomFrequency()[1] + ' days'}"></span>
                                </div>
                            </div>

                            <div class="mt-3" th:each="habit : ${sharedHabit.habits}">

                                <div class="habit-progress">
                                    <div class="habit-progress-bar"
                                         th:style="'width: ' + ${progressOfHabits.get(sharedHabit).get(habit)} + '%'"></div>
                                </div>
                                <div class="habit-meta">
                                    <div class="habit-meta-item">
                                        <i class="bi bi-person"></i>
                                        <span th:utext="${habit.account.getAuthenticationId() == #authentication.name ? '<b>you</b>': habit.account.getDisplayName() }"></span>
                                    </div>
                                </div>

                            </div>
                        </a>
                        <div class="habit-actions mt-3">
                            <a class="btn btn-sm btn-primary" th:href="@{'/shared/' + ${sharedHabit.shareCode}}">
                                <i class="bi bi-eye me-1"></i> Details
                            </a>
                            <button class="btn btn-sm btn-outline-secondary copy-code"
                                    th:data-code="${baseUrl + 'shared/' + sharedHabit.shareCode}">
                                <i class="bi bi-clipboard me-1"></i> Share
                            </button>
                            <a class="btn btn-sm btn-primary"
                               th:href="@{'/shared/' + ${sharedHabit.shareCode} + '/edit'}"
                               th:if="${((sharedHabit.owner != null) && (sharedHabit.owner.getAuthenticationId() == #authentication.name)) || sharedHabit.allowEditingOfAllUsers}">
                                <i class="bi bi-pencil-square me-1"></i> Edit
                            </a>
                            <button
                                    class="btn btn-sm btn-success"
                                    onclick="loadMedalOverview(this.dataset.sharecode, this.dataset.username)"
                                    th:data-sharecode="${sharedHabit.shareCode}"
                                    th:data-username="${#authentication.name}">
                                <i class="bi bi-trophy me-1"></i> Medals
                            </button>
                            <form method="post" th:action="@{'/shared/' + ${sharedHabit.shareCode} + '/remove'}"
                                  th:if="${sharedHabit.habits.size() == 1}">
                                <button class="btn btn-sm btn-danger" type="submit">
                                    <i class="bi bi-trash me-1"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty Shared Habits State -->
        <div class="mt-5" th:if="${sharedHabits.empty && !habits.empty}">
            <h3 class="mb-3">Shared Habit Groups</h3>
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-people"></i>
                </div>
                <h4>No shared habit groups yet</h4>
                <p>Share your habits with friends or join existing groups to track progress together.</p>
                <div class="mt-4">
                    <button class="btn btn-outline-success" data-bs-target="#joinSharedModal" data-bs-toggle="modal">
                        <i class="bi bi-box-arrow-in-right me-1"></i> Join Group
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Medal Modal -->
    <div class="medal-modal" id="medalOverviewModal">
        <div class="medal-modal-content">
            <span class="close-modal">&times;</span>
            <h2>Medal Overview</h2>
            <div class="loading-spinner" id="medalLoading">
                <div class="spinner"></div>
            </div>
            <div class="medal-content" id="medalContent"></div>
        </div>
    </div>
</div>
</body>
</html>