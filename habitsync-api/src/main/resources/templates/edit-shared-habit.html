<!DOCTYPE html>
<html layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Share Habit</title>
    <link rel="stylesheet" th:href="@{/css/edit-shared-habit.css}">
</head>
<body>
<div layout:fragment="page-title">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3">Share Habit: <span th:text="${sharedHabit.title}"></span></h1>
        <button class="btn btn-outline-secondary" onclick="history.back()">
            <i class="bi bi-arrow-left me-1"></i> Back
        </button>
    </div>
</div>

<div layout:fragment="content">
    <div class="card mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0">Configure Share Link</h5>
        </div>
        <div class="card-body">
            <p>Change settings of your share link</p>

            <form id="shared-habit-form" method="post" th:action="@{'/shared/' + ${sharedHabit.shareCode} + '/edit'}">
                <div class="form-section">
                    <h6 class="form-section-title">Share Information</h6>
                    <div class="mb-3">
                        <label class="form-label" for="title">Title for shared tracking</label>
                        <input class="form-control" id="title" name="title" required th:value="${sharedHabit.title}"
                               type="text">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" for="description">Description (optional)</label>
                        <textarea class="form-control" id="description" name="description"
                                  placeholder="Let others know what this habit tracking is about" rows="3"
                                  th:text="${sharedHabit.description}"></textarea>
                    </div>
                    <div class="mb-3" th:if="${sharedHabit.owner.getAuthenticationId() == #authentication.name}">
                        <div class="form-check form-switch">
                            <input class="form-check-input form-control" id="allowEditingOfAllUsers"
                                   name="allowEditingOfAllUsers"
                                   role="switch" th:checked="${sharedHabit.allowEditingOfAllUsers}"
                                   type="checkbox">
                            <label class="form-check-label" for="allowEditingOfAllUsers">Allow editing by all
                                users</label>
                        </div>
                    </div>
                    <input name="allowEditingOfAllUsers"
                           th:if="${sharedHabit.owner.getAuthenticationId() != #authentication.name}"
                           th:value="${sharedHabit.allowEditingOfAllUsers ? 'on' : 'off'}"
                           type="hidden">
                </div>

                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Notification Rules (also used for progress computation)</h5>
                        <button class="btn btn-sm btn-primary" data-bs-target="#addRuleModal" data-bs-toggle="modal"
                                type="button">
                            <i class="bi bi-plus-circle me-1"></i>Add Rule
                        </button>
                    </div>

                    <!-- Empty state when no rules -->
                    <div class="text-center py-4 bg-light rounded"
                         th:if="${notificationRules == null || notificationRules.isEmpty()}">
                        <div class="mb-3">
                            <i class="bi bi-bell-slash" style="font-size: 2rem; color: #adb5bd;"></i>
                        </div>
                        <h6 class="text-muted">No notification / progress computation rules yet</h6>
                        <p class="text-muted small">Add notification rules unify progress computation and motivate
                            participants</p>
                    </div>

                    <div class="rule-list" th:if="${notificationRules != null && !notificationRules.isEmpty()}">
                        <div class="rule-card" th:each="rule, ruleStat : ${notificationRules}">
                            <span class="progress-computation-rule"
                                  th:if="${sharedHabit.mainNotificationRuleId == rule.id}">
                                <i class="bi bi-exclamation-circle"></i>&nbsp;Used for progress computation of participants
                            </span>
                            <div class="rule-header">
                                <span class="rule-type-badge"
                                      th:text="${rule.notificationTypeLabel}">Notification Type</span>
                                <div class="rule-actions">
                                    <button class="btn btn-sm btn-outline-primary"
                                            th:onclick="'editRule(' + ${ruleStat.index} + ',' + ${rule.id} +')'"
                                            type="button">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger"
                                            th:onclick="'deleteRule(' + ${rule.id} + ')'"
                                            type="button">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <a th:href="${'/shared/'+sharedHabit.getShareCode()+'/edit/set-main-rule/'+rule.id}"
                                       th:unless="${sharedHabit.mainNotificationRuleId == rule.id}">
                                        <button class="btn btn-sm btn-outline-info" type="button">
                                            <i class="bi bi-star"></i>
                                        </button>
                                    </a>
                                    <a th:if="${sharedHabit.mainNotificationRuleId == rule.id}">
                                        <button class="btn btn-sm btn-outline-info" type="button">
                                            <i class="bi bi-star-fill"></i>
                                        </button>
                                    </a>
                                </div>
                            </div>
                            <div class="rule-body">
                                <div class="row g-3">
                                    <div class="col-md-6" th:if="${rule.percentageNeeded != null}">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-percent me-2 text-primary"></i>
                                            <div>
                                                <small class="text-muted d-block">Percentage Needed</small>
                                                <strong th:text="${rule.percentageNeeded} + '%'">50%</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-stars me-2 text-primary"></i>
                                            <div>
                                                <small class="text-muted d-block">Daily reachable value</small>
                                                <strong th:text="${rule.dailyReachableValue + ' ' + rule.dailyScoreUnit}">1</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-bullseye me-2 text-primary"></i>
                                            <div>
                                                <small class="text-muted d-block">Target Days</small>
                                                <strong th:text="${rule.targetDays}">30</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Hidden inputs to store rule data -->
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].notificationType'"
                                       th:value="${rule.notificationType}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].percentageNeeded'"
                                       th:value="${rule.percentageNeeded}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].numberOfDays'"
                                       th:value="${rule.numberOfDays}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].dailyScore'"
                                       th:value="${rule.dailyScore}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].dailyScoreUnit'"
                                       th:value="${rule.dailyScoreUnit}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].dailyReachableValue'"
                                       th:value="${rule.dailyReachableValue}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].freqType'"
                                       th:value="${rule.freqType}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].freqCustomSingle'"
                                       th:value="${rule.freqCustomSingle}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].freqCustomTimes'"
                                       th:value="${rule.freqCustomTimes}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].freqCustomDays'"
                                       th:value="${rule.freqCustomDays}"
                                       type="hidden">
                                <input th:name="'notificationRules[' + ${ruleStat.index} + '].targetDays'"
                                       th:value="${rule.targetDays}"
                                       type="hidden">
                            </div>
                        </div>
                    </div>
                </div>

            </form>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a th:href="@{'/shared/' + ${sharedHabit.getShareCode()}}">
                    <button class="btn btn-success">
                        <i class="bi bi-floppy me-1"></i> View Shared Habit
                    </button>
                </a>
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button class="btn btn-primary">
                    <i class="bi bi-floppy me-1"></i> Save Shared Habit
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Rule Modal -->
    <div aria-hidden="true" aria-labelledby="addRuleModalLabel" class="modal fade" id="addRuleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addRuleModalLabel">Add Notification/Computation Rule</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <form id="ruleForm" method="post"
                      th:action="@{'/shared/' + ${sharedHabit.getShareCode()} + '/edit/add-rule'}">
                    <div class="modal-body">
                        <input id="editRuleIndex" name="editRuleIndex" type="hidden" value="-1">

                        <!-- Notification Type -->
                        <div class="mb-3">
                            <label class="form-label" for="notificationType">Notification Type</label>
                            <select class="form-select" id="notificationType" name="notificationType">
                                <option value="PERCENTAGE_REACHED_BY_SOMEONE_ELSE">Percentage Reached By Someone Else
                                </option>
                                <option value="PERCENTAGE_REACHED_BY_ANYONE">Percentage Reached By Anyone</option>
                                <option value="NEW_RECORD_OF_OTHER_USER">New Record Of Other User</option>
                                <option value="NO_OWN_RECORD_FOR_CERTAIN_TIME">No Own Record For Certain Time</option>
                            </select>
                        </div>

                        <!-- Type-specific parameter fields -->
                        <div class="mb-3" id="percentageNeededField">
                            <label class="form-label" for="percentageNeeded">Percentage Needed</label>
                            <div class="input-group">
                                <input class="form-control" id="percentageNeeded" max="100" min="1"
                                       name="percentageNeeded" type="number" value="50">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>

                        <div class="mb-3" id="numberOfDaysField" style="display: none;">
                            <label class="form-label" for="numberOfDays">Number of Days</label>
                            <div class="input-group">
                                <input class="form-control" id="numberOfDays" min="1" name="numberOfDays" type="number"
                                       value="3">
                                <span class="input-group-text">days</span>
                            </div>
                        </div>

                        <hr>
                        <h6>Notification Goal Configuration</h6>

                        <!-- Daily Score -->
                        <div class="mb-3">
                            <label class="form-label" for="dailyScore">Daily Goal</label>
                            <input class="form-control" data-bs-toggle="tooltip" id="dailyScore" min="1"
                                   name="dailyScore"
                                   title="Number that has to be reached for the habit to be completed on one day.
                   If you just want to track done/not done use 1 as default"
                                   type="number"
                                   value="1">
                        </div>

                        <!-- Daily Score Unit-->
                        <div class="mb-3">
                            <label class="form-label" for="dailyScoreUnit">Daily Goal Unit</label>
                            <input class="form-control" data-bs-toggle="tooltip" id="dailyScoreUnit"
                                   name="dailyScoreUnit"
                                   title="Unit for your daily goal. I want to run 1km a month -> unit is km">
                        </div>

                        <!-- Daily reachable value-->
                        <div class="mb-3">
                            <label class="form-label" for="dailyReachableValue">Daily reachable value</label>
                            <input class="form-control" data-bs-toggle="tooltip" id="dailyReachableValue"
                                   name="dailyReachableValue"
                                   title="Set the maximum daily reachable value. This is usefull if you want to say for example:
Run 30km per month, but want to be able to freely choose how much to run each day. Choose daily goal 4 and unit km. Set
daily reachable value to 30. The default value for the daily completion will be 4km. To reach the goal you will need to reach
30km in sum over the whole month.">
                        </div>

                        <!-- Frequency Type -->
                        <div class="mb-3">
                            <label class="form-label" for="freqType">Frequency Type</label>
                            <select class="form-select" id="freqType" name="freqType">
                                <option value="1">Weekly</option>
                                <option value="2">Monthly</option>
                                <option value="3">X times in X days</option>
                            </select>
                        </div>

                        <!-- Frequency Custom -->
                        <div class="mb-3" id="freqCustomWeeklyMonthly">
                            <label class="form-label" for="freqCustomSingle">Times per Week/Month</label>
                            <input class="form-control" id="freqCustomSingle" min="1" name="freqCustomSingle"
                                   type="number" value="3">
                        </div>

                        <div class="mb-3" id="freqCustomXDays" style="display: none;">
                            <div class="row">
                                <div class="col">
                                    <label class="form-label" for="freqCustomTimes">Times</label>
                                    <input class="form-control" id="freqCustomTimes" min="1"
                                           name="freqCustomTimes" type="number" value="3">
                                </div>
                                <div class="col">
                                    <label class="form-label" for="freqCustomDays">Days</label>
                                    <input class="form-control" id="freqCustomDays" min="1" name="freqCustomDays"
                                           type="number" value="7">
                                </div>
                            </div>
                        </div>

                        <!-- Target Days -->
                        <div class="mb-3">
                            <label class="form-label" for="targetDays">Target Days (Until 100%)</label>
                            <input class="form-control" id="targetDays" min="1" name="targetDays" type="number"
                                   value="30">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                        <button class="btn btn-primary" id="saveRuleBtn" type="submit">Add Rule</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Get modal element
        const ruleModal = new bootstrap.Modal(document.getElementById('addRuleModal'));
        const ruleForm = document.getElementById('ruleForm');
        const editRuleIndex = document.getElementById('editRuleIndex');
        const modalTitle = document.getElementById('addRuleModalLabel');
        const saveRuleBtn = document.getElementById('saveRuleBtn');

        // Show/hide notification type specific fields
        document.getElementById('notificationType')?.addEventListener('change', function () {
            const percentageNeededField = document.getElementById('percentageNeededField');
            const numberOfDaysField = document.getElementById('numberOfDaysField');

            // Hide all fields first
            percentageNeededField.style.display = 'none';
            numberOfDaysField.style.display = 'none';

            // Show relevant fields based on notification type
            switch (this.value) {
                case 'PERCENTAGE_REACHED_BY_SOMEONE_ELSE':
                case 'PERCENTAGE_REACHED_BY_ANYONE':
                    percentageNeededField.style.display = 'block';
                    break;
                case 'NO_OWN_RECORD_FOR_CERTAIN_TIME':
                    numberOfDaysField.style.display = 'block';
                    break;
            }
        });

        // Show/hide frequency custom fields based on frequency type
        document.getElementById('freqType')?.addEventListener('change', function () {
            const freqCustomWeeklyMonthly = document.getElementById('freqCustomWeeklyMonthly');
            const freqCustomXDays = document.getElementById('freqCustomXDays');

            if (this.value === '3') {
                freqCustomWeeklyMonthly.style.display = 'none';
                freqCustomXDays.style.display = 'block';
            } else {
                freqCustomWeeklyMonthly.style.display = 'block';
                freqCustomXDays.style.display = 'none';
            }
        });

        // Initialize the display settings
        document.addEventListener('DOMContentLoaded', function () {
            const notificationType = document.getElementById('notificationType');
            const freqType = document.getElementById('freqType');

            if (notificationType) {
                notificationType.dispatchEvent(new Event('change'));
            }

            if (freqType) {
                freqType.dispatchEvent(new Event('change'));
            }

            // Copy link functionality
            document.getElementById('copyButton')?.addEventListener('click', function () {
                const shareLink = document.getElementById('shareLink');
                shareLink.select();
                document.execCommand('copy');
                this.innerHTML = '<i class="bi bi-check2 me-1"></i>Copied!';
                setTimeout(() => {
                    this.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copy';
                }, 2000);
            });
        });

        // Function to edit a rule
        function editRule(index, id) {
            editRuleIndex.value = index;
            modalTitle.textContent = 'Edit Notification Rule';
            saveRuleBtn.textContent = 'Update Rule';

            // Get rule data from hidden fields
            const notificationType = document.querySelector(`input[name='notificationRules[${index}].notificationType']`).value;
            const percentageNeeded = document.querySelector(`input[name='notificationRules[${index}].percentageNeeded']`).value;
            const numberOfDays = document.querySelector(`input[name='notificationRules[${index}].numberOfDays']`).value;
            const dailyScore = document.querySelector(`input[name='notificationRules[${index}].dailyScore']`).value;
            const dailyScoreUnit = document.querySelector(`input[name='notificationRules[${index}].dailyScoreUnit']`).value;
            const dailyReachableValue = document.querySelector(`input[name='notificationRules[${index}].dailyReachableValue']`).value;
            const freqType = document.querySelector(`input[name='notificationRules[${index}].freqType']`).value;
            const freqCustomSingle = document.querySelector(`input[name='notificationRules[${index}].freqCustomSingle']`).value;
            const freqCustomTimes = document.querySelector(`input[name='notificationRules[${index}].freqCustomTimes']`).value;
            const freqCustomDays = document.querySelector(`input[name='notificationRules[${index}].freqCustomDays']`).value;
            const targetDays = document.querySelector(`input[name='notificationRules[${index}].targetDays']`).value;

            // Set form values
            document.getElementById('notificationType').value = notificationType;
            document.getElementById('percentageNeeded').value = percentageNeeded || '50';
            document.getElementById('numberOfDays').value = numberOfDays || '3';
            document.getElementById('dailyScore').value = dailyScore || '1';
            document.getElementById('dailyScoreUnit').value = dailyScoreUnit;
            document.getElementById('dailyReachableValue').value = dailyReachableValue;
            document.getElementById('freqType').value = freqType;
            document.getElementById('freqCustomSingle').value = freqCustomSingle || '3';
            document.getElementById('freqCustomTimes').value = freqCustomTimes || '3';
            document.getElementById('freqCustomDays').value = freqCustomDays || '7';
            document.getElementById('targetDays').value = targetDays;

            // Update the form action
            var baseUrl = /*[[@{'/shared/' + ${sharedHabit.getShareCode()} + '/edit/edit-rule/'}]]*/ "";
            ruleForm.action = baseUrl + id;

            // Trigger change events to update UI
            document.getElementById('notificationType').dispatchEvent(new Event('change'));
            document.getElementById('freqType').dispatchEvent(new Event('change'));

            // Show modal
            ruleModal.show();
        }

        // Function to delete a rule
        function deleteRule(index) {
            if (confirm('Are you sure you want to delete this notification rule?')) {
                // Create a form to submit the delete request
                const form = document.createElement('form');
                form.method = 'post';
                var baseUrl = /*[[@{'/shared/' + ${sharedHabit.getShareCode()} + '/edit/delete-rule/'}]]*/ "";
                form.action = baseUrl + index;
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Reset form when adding a new rule
        document.querySelector('[data-bs-target="#addRuleModal"]')?.addEventListener('click', function () {
            editRuleIndex.value = -1;
            modalTitle.textContent = 'Add Notification Rule';
            saveRuleBtn.textContent = 'Add Rule';
            ruleForm.reset();
            ruleForm.action = /*[[@{'/shared/' + ${sharedHabit.getShareCode()} + '/edit/add-rule'}]]*/ '';

            // Set default values
            document.getElementById('percentageNeeded').value = '50';
            document.getElementById('numberOfDays').value = '3';
            document.getElementById('dailyScore').value = '1';
            document.getElementById('dailyScoreUnit').value = '';
            document.getElementById('freqCustomSingle').value = '3';
            document.getElementById('freqCustomTimes').value = '3';
            document.getElementById('freqCustomDays').value = '7';
            document.getElementById('targetDays').value = '30';

            // Trigger change events to update UI
            document.getElementById('notificationType').dispatchEvent(new Event('change'));
            document.getElementById('freqType').dispatchEvent(new Event('change'));
        });

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('#shared-habit-form');

            // Get the action URL from the form
            const postUrl = form.getAttribute('action');

            // Function to serialize the form data into a JSON object
            function serializeForm(formElement) {
                const formData = new FormData(formElement);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                return data;
            }

            // Function to send the auto-save POST request
            function autoSave() {
                const data = serializeForm(form);

                fetch(postUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'  // Optional: to signal AJAX
                    },
                    body: JSON.stringify(data)
                }).then(response => {
                    if (!response.ok) {
                        console.error('Auto-save failed:', response.statusText);
                    } else {
                        console.log('Auto-saved successfully');
                    }
                }).catch(error => {
                    console.error('Auto-save error:', error);
                });
            }

            // Attach blur event listener to all inputs and textareas
            const fields = form.querySelectorAll('input, textarea');
            fields.forEach(field => {
                field.addEventListener('blur', autoSave);
            });
        });
    </script>
</th:block>
</body>
</html>