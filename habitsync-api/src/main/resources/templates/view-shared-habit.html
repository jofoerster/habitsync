<!DOCTYPE html>
<html layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${sharedHabit.title + ' - Habit Tracker'}">Shared Habit</title>
</head>
<body>
<div layout:fragment="page-title">Shared Habit</div>

<div layout:fragment="content">
    <div class="mb-4">
        <button class="btn btn-outline-secondary" onclick="history.back()">
            <i class="bi bi-arrow-left me-1"></i> Back
        </button>
        <a class="btn btn-outline-secondary"
           th:href="${sharedHabit.shareCode+'/edit'}"
           th:if="${(sharedHabit.owner.getAuthenticationId() == #authentication.name || sharedHabit.allowEditingOfAllUsers) &&
           sharedHabit.habits.?[account.getAuthenticationId() == #authentication.name].size() > 0}">
            <i class="bi bi-gear me-1"></i> Edit Shared Habit
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h3 th:text="${sharedHabit.title}">Shared Habit Title</h3>
            <p class="text-muted" th:if="${sharedHabit.description}" th:text="${sharedHabit.description}"></p>
        </div>
        <div class="card-body">
            <!-- Participants section -->

            <!-- Empty state for no habits -->
            <div class="empty-state" th:if="${sharedHabit.habits.empty}">
                <div class="empty-state-icon">
                    <i class="bi bi-people"></i>
                </div>
                <h4>No participants yet</h4>
                <p>Be the first to join this shared habit tracking!</p>
            </div>

            <!-- shared habit configuration-->
            <div class="shared-habit-config"
                 th:with="intHabit=${sharedHabit.getTemporaryMainNotificationRule(notificationRuleService, null).getInternalHabitForComputationOfGoal()}">
                <div class="habit-config-item">
                    <i class="bi bi-bullseye"></i>
                    <span th:text="${intHabit.getReachableDailyValue() + ' ' + (intHabit.dailyGoalUnit != null ? intHabit.dailyGoalUnit : '')}"></span>
                </div>
                <div class="habit-config-item">
                    <i class="bi bi-calendar-check"></i>
                    <span th:if="${intHabit.freqType == 1}"
                          th:text="${intHabit.parseFrequencyValue() + ' times per week'}"></span>
                    <span th:if="${intHabit.freqType == 2}"
                          th:text="${intHabit.parseFrequencyValue() + ' times per month'}"></span>
                    <span th:if="${intHabit.freqType == 3 && intHabit.freqCustom == '[1,1]'}"
                          th:text="${'daily'}"></span>
                    <span th:if="${intHabit.freqType == 3 && intHabit.freqCustom != '[1,1]'}"
                          th:text="${intHabit.parseCustomFrequency()[0] + ' times per ' + intHabit.parseCustomFrequency()[1] + ' days'}"></span>
                </div>
            </div>

            <!-- Participants list -->
            <div class="row g-3" th:if="${!sharedHabit.habits.empty}">
                <div class="card habit-card" th:attr="data-color=${sharedHabit.getHabits().iterator().next().color}">
                    <div class="card-body position-relative">
                        <div class="streak-badge">
                            <i class="bi"></i>
                            <span th:text="${sharedHabit.habits.size() + ' participants'}"></span>
                        </div>

                        <h5 class="card-title">Participants' Progress</h5>

                        <div class="mt-3" th:each="habit : ${sharedHabit.getHabits()}">

                            <div class="habit-progress">
                                <div class="habit-progress-bar"
                                     th:style="'width: ' + ${progressOfHabits.get(habit)} + '%'"></div>
                            </div>


                            <div class="habit-meta">
                                <div class="habit-meta-item">
                                    <i class="bi bi-person"></i>
                                    <span th:utext="${habit.account.getAuthenticationId() == #authentication.name ? '<b>you</b>': habit.account.getDisplayName() }"></span>
                                </div>
                                <div class="habit-meta-item"
                                     th:if="${sharedHabit.habits.?[account.getAuthenticationId() == #authentication.name].size() > 0}">
                                    <a th:href="@{'/habit/' + ${habit.uuid}}">
                                        <i class="bi bi-info-circle"></i>
                                        <span>Details</span>
                                    </a>
                                </div>
                                <div class="habit-meta-item"
                                     th:if="${habit.account.getAuthenticationId() != #authentication.name &&
                                     sharedHabit.habits.?[account.getAuthenticationId() == #authentication.name].size() > 0}">
                                    <a th:href="@{'/shared/' + ${sharedHabit.shareCode} + '/notify/' + ${habit.account.getAuthenticationId()}}">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <span> Notify user now</span>
                                    </a>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-light mt-4"
                 th:if="${!(sharedHabit.habits.?[account.getAuthenticationId() == #authentication.name].size() > 0)}">
                <div class="card-body">
                    <h5 class="mb-3">Join this habit tracking</h5>
                    <p>Add one of your habits to join this shared tracking and compare progress with others!</p>

                    <form method="post" th:action="@{'/shared/' + ${sharedHabit.shareCode} + '/add'}">
                        <div class="mb-3">
                            <label class="form-label" for="habitUuid">Select your habit</label>
                            <select class="form-select" id="habitUuid" name="habitUuid" required>
                                <option disabled selected value="">Choose your habit...</option>
                                <option th:disabled="${sharedHabit.habits.contains(habit)}"
                                        th:each="habit : ${userHabits}"
                                        th:text="${habit.name}"
                                        th:value="${habit.uuid}">
                                </option>
                            </select>
                        </div>
                        <button class="btn btn-primary" type="submit"
                        >
                            <i class="bi bi-box-arrow-in-right me-1"></i> Join Tracking
                        </button>

                        <!-- Empty state messaging -->
                        <div class="form-text" th:if="${userHabits.empty}">
                            You don't have any habits to add. <a href="/habits">Create a habit first</a>.
                        </div>
                        <div class="form-text"
                             th:if="${sharedHabit.habits.?[account.getAuthenticationId() == #authentication.name].size() > 0}">
                            You've already joined this tracking.
                        </div>
                    </form>
                </div>
            </div>

            <!-- Share with others section -->
            <div class="card bg-light mt-3">
                <div class="card-body">
                    <h5 class="mb-3">Share with others</h5>
                    <p>Share this code with friends to invite them to join this habit tracking group.</p>

                    <div class="input-group">
                        <input class="form-control" id="shareCodeInput" readonly
                               th:value="${baseUrl + 'shared/' +sharedHabit.shareCode}"
                               type="text">
                        <button class="btn btn-outline-secondary copy-code"
                                th:data-code="${baseUrl + 'shared/' +sharedHabit.shareCode}"
                                type="button">
                            <i class="bi bi-clipboard me-1"></i> Copy
                        </button>
                    </div>
                </div>
            </div>

            <div class="card bg-light mt-3"
                 th:if="${sharedHabit.habits.?[account.getAuthenticationId() == #authentication.name].size() > 0}">
                <form method="post" th:action="@{'/shared/' + ${sharedHabit.shareCode} + '/remove'}">
                    <button class="btn btn-sm btn-outline-danger" type="submit">
                        <i class="bi bi-link-break me-1"></i> Unlink my habit and leave shared habit
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Page-specific scripts -->
<script layout:fragment="scripts" th:inline="javascript">
    // Copy share code functionality
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.copy-code').forEach(button => {
            button.addEventListener('click', function () {
                const code = this.getAttribute('data-code');
                navigator.clipboard.writeText(code)
                    .then(() => {
                        const originalText = this.innerHTML;
                        this.innerHTML = '<i class="bi bi-check-lg me-1"></i> Copied!';
                        setTimeout(() => {
                            this.innerHTML = originalText;
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy code');
                    });
            });
        });
    });
</script>
</body>
</html>