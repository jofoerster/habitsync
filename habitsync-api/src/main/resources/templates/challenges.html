<!DOCTYPE html>
<html layout:decorate="~{layout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Challenges</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link rel="stylesheet" th:href="@{/css/challenges.css}">
    <script defer th:src="@{/js/challenges.js}"></script>
</head>
<body>
<div layout:fragment="page-title">Challenges</div>

<div layout:fragment="content">
    <div class="challenges-container">
        <div class="alert alert-danger" th:if="${challengeHabit == null}"> Please choose a habit for challenges. Connect
            an external habit on your
            <a th:href="${'/profile'}">profile page</a> or do it <a th:href="${'/challenge/connect-internal-habit'}">automatically</a>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons" style="margin-bottom: 1.5rem;">
            <a class="btn btn-secondary" href="/challenge/list">Challenge List and Votes</a>
            <button class="btn btn-primary" id="openModalBtn">Propose new Challenge</button>
        </div>

        <div class="challenge-grid">
            <!-- Main Content Column -->
            <div class="main-content">
                <!-- Active Challenge Card -->
                <div class="card" th:if="${challenge}">
                    <div class="card-header">
                        Current Active Challenge
                    </div>
                    <div class="card-body">
                        <div class="challenge-details">
                            <dl>
                                <dt>Title</dt>
                                <dd th:text="${challenge.title}">Challenge Title</dd>

                                <dt>Description</dt>
                                <dd th:text="${challenge.description}">Challenge Description</dd>

                                <dt>Duration</dt>
                                <dd>
                                    <span th:text="${#temporals.format(challenge.startDate, 'MMM dd, yyyy')}">Start Date</span>
                                    -
                                    <span th:text="${#temporals.format(challenge.endDate, 'MMM dd, yyyy')}">End Date</span>
                                    <span id="endDate" th:text="${challenge.endDate}"></span>
                                    <span>(<span id="countdown"></span>)</span>
                                </dd>

                                <dt>Computation Type</dt>
                                <dd th:text="${challenge.computationType}">RELATIVE/ABSOLUTE</dd>

                                <dt>Rule</dt>
                                <dd>
                                    Daily reachable value: <span
                                        th:text="${challenge.rule.internalHabitForComputationOfGoal.getReachableDailyValue() + ' '
                                        + challenge.rule.internalHabitForComputationOfGoal.getDailyGoalUnit()}">0</span><br>
                                    <span th:if="${challenge.rule.internalHabitForComputationOfGoal.freqType == 1}">
                                        <span th:text="${challenge.rule.internalHabitForComputationOfGoal.freqCustom}">0</span> times per week
                                    </span>
                                    <span th:if="${challenge.rule.internalHabitForComputationOfGoal.freqType == 2}">
                                        <span th:text="${challenge.rule.internalHabitForComputationOfGoal.freqCustom}">0</span> times per month
                                    </span>
                                    <span th:if="${challenge.rule.internalHabitForComputationOfGoal.freqType == 3}">
                                        <span th:text="${#strings.arraySplit(challenge.rule.internalHabitForComputationOfGoal.freqCustom, ',')[0]}">0</span> times per
                                        <span th:text="${#strings.arraySplit(challenge.rule.internalHabitForComputationOfGoal.freqCustom, ',')[1]}">0</span> days
                                    </span>
                                </dd>
                                <dd th:if="${challengeHabit != null && challengeHabit.habitType == T(de.jntn.habit.syncserver.model.HabitType).INTERNAL}">
                                    <div class="action-buttons" style="margin-bottom: 1.5rem;">
                                        <a class="btn btn-secondary" href="/habit/tracker">Track Progress</a>
                                    </div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <!-- No Active Challenge -->
                <div class="card" th:unless="${challenge}">
                    <div class="card-header">
                        No Active Challenge
                    </div>
                    <div class="card-body">
                        <p>There is currently no active challenge. Propose a new challenge for next month!</p>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="card">
                    <div class="card-header">
                        Current Progress
                    </div>
                    <div class="card-body">
                        <div th:if="${accountPercentageScore.isEmpty()}">
                            <p>No progress data available yet.</p>
                        </div>
                        <div class="progress-container" th:each="entry : ${accountPercentageScore}">
                            <div class="progress-label">
                                <span>
                                    <span th:text="${entry.key.getDisplayName()}">User</span>&nbsp;
                                    <span>
                                        <a th:href="@{${entry.value.getLinkToHabit()}}">
                                            <i class="bi bi-info-circle"></i>
                                            <span>Details</span>
                                        </a>
                                    </span>
                                </span>
                                <span th:text="${#numbers.formatDecimal(entry.value.getPercentage(), 0, 0) + '% | ' +
                                #numbers.formatDecimal(entry.value.getTotal(),0,1) + ' ' + entry.value.getChallengeUnit()}">0%</span>
                                <span th:if="${entry.value.getMaxValue() != null}"
                                      th:text="${#numbers.formatDecimal(entry.value.getMaxValue(), 0, 0) + ' highest value'}">no values</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar"
                                     th:style="'width: ' + ${entry.value.getPercentage()} + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Column -->
            <div class="sidebar">
                <!-- Leaderboard Card -->
                <div class="card">
                    <div class="card-header">
                        Leaderboard
                    </div>
                    <div class="card-body">
                        <div th:if="${leaderboard.isEmpty()}">
                            <p>No leaderboard data available yet.</p>
                        </div>
                        <table class="leaderboard-table" th:unless="${leaderboard.isEmpty()}">
                            <thead>
                            <tr>
                                <th>Rank</th>
                                <th>User</th>
                                <th>Points</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="entry, status : ${leaderboard}">
                                <td th:text="${status.count}">1</td>
                                <td th:text="${entry.key.getDisplayName()}">User</td>
                                <td th:text="${entry.value}">0</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Challenge Modal -->
    <div class="modal" id="createChallengeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Challenge</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form method="post" th:action="@{/challenge}" th:object="${challengeForCreation}">
                <div class="form-group">
                    <label class="form-label" for="title">Title</label>
                    <input class="form-control" id="title" required th:field="*{title}" type="text">
                </div>

                <div class="form-group">
                    <label class="form-label" for="description">Description</label>
                    <textarea class="form-control" id="description" rows="3" th:field="*{description}"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="computationType">Computation Type</label>
                    <select class="form-select" id="computationType" required th:field="*{computationType}">
                        <option value="RELATIVE">Percentage relative to other participants</option>
                        <option value="ABSOLUTE">Normal percentage of each user</option>
                        <option value="MAX_VALUE">Highest recorded record</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="dailyGoal">Daily Goal</label>
                    <input class="form-control" data-bs-toggle="tooltip" id="dailyGoal"
                           required th:field="*{rule.internalHabitForComputationOfGoal.dailyGoal}"
                           title="Number that has to be reached for the habit to be completed on one day.
                   If you just want to track done/not done use 1 as default"
                           type="number">
                </div>

                <div class="form-group">
                    <label class="form-label" for="dailyGoalUnit">Daily Goal Unit</label>
                    <input class="form-control" data-bs-toggle="tooltip" id="dailyGoalUnit"
                           th:field="*{rule.internalHabitForComputationOfGoal.dailyGoalUnit}"
                           title="Unit for your daily goal. For habit: Run 10km a week you can set the unit to km">
                </div>

                <div class="form-group">
                    <label class="form-label" for="freqType">Frequency Type</label>
                    <select class="form-select" id="freqType"
                            onchange="updateFreqCustomForm()" required
                            th:field="*{rule.internalHabitForComputationOfGoal.freqType}">
                        <option value="1">Weekly</option>
                        <option value="2">Monthly</option>
                        <option value="3">X times per Y days</option>
                    </select>
                </div>

                <div class="form-group freqcustom-1-2">
                    <label class="form-label" for="freqCustomSimple">Times per week/month</label>
                    <input class="form-control" id="freqCustomSimple" type="number">
                </div>

                <div class="form-group hidden-freqcustom freqcustom-3">
                    <div class="form-row">
                        <div>
                            <label class="form-label" for="freqCustomX">X (times)</label>
                            <input class="form-control" id="freqCustomX" type="number">
                        </div>
                        <div>
                            <label class="form-label" for="freqCustomY">Y (days)</label>
                            <input class="form-control" id="freqCustomY" type="number">
                        </div>
                    </div>
                </div>

                <input id="freqCustom" th:field="*{rule.internalHabitForComputationOfGoal.freqCustom}" type="hidden">

                <div style="margin-top: 1.5rem; text-align: right;">
                    <button class="btn btn-secondary close-modal-btn" type="button">Cancel</button>
                    <button class="btn btn-primary" type="submit">Create Challenge</button>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>